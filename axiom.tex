\chapter{Semantica assiomatica}

[Da scrivere.]

\section{Logica di specifica}\marginpar{Lombardi}
\input{logica_di_specifica}

\subsection{Programma propriamente annotato}\marginpar{Mancino}
\begin{definizione}
Un programma si dice \emph{propriamente annotato} se ci sono annotazioni nei seguenti punti:
\begin{itemize}
	\item Prima ogni comando $C_i$ in una composizione sequenziale $C_1;C_2; \dots ;C_n$ in cui $C_i$ non è un comando di assegnamento.
	\item Dopo la parola \textbf{do} in un comando \textbf{while}.
\end{itemize}
\end{definizione}


\section{Esercizi}\marginpar{Mancino}
\newcommand{\mactext}[1]{\text{\texttt{#1}}}
% Comando per scrivere con texttt dentro una formula matematica

\subsection{Esercizio 1}
Dare una dimostrazione per la seguente tripla di Hoare:
$$ \{X=a \; \land Y=b\} \; X:=X+Y; \; Y:=X-Y; \; X:=X-Y \; \{Y=a \; \land \; X=b\} $$

\begin{proof}[Svolgimento]
Dimostriamo la tripla partendo dal fondo. Applicando l'assioma dell'assegnamento si ha:
$$ \{S[\nicefrac{X-Y}{X}] \} \; X:=X-Y \; \{Y=a \; \land \; X=b\} $$
$$ \Downarrow $$
$$ \{Y=a \; \land X-Y=b \} \; X:=X-Y \; \{Y=a \; \land \; X=b\} $$
Risaliamo ora di un "livello" applicando ancora l'assioma dell'assegnamento:
$$ \{S[\nicefrac{X-Y}{Y}] \} \; Y:=X-Y \; \{Y=a \; \land \; X-Y=b\} $$
$$ \Downarrow $$
$$ \{X-Y=a \; \land X-(X-Y)=b \} \; Y:=X-Y \; \{Y=a \; \land \; X-Y=b\} $$
Semplificando la precondizione si ottiene:
$$ \{X-Y=a \; \land Y=b \} \; Y:=X-Y \; \{Y=a \; \land \; X-Y=b\} $$
Risaliamo ulteriormente di un livello, applicando l'assioma dell'assegnamento. Si ha:
$$ \{S[\nicefrac{X+Y}{Y}] \} \; X:=X+Y \; \{X-Y=a \; \land \; Y=b\} $$
$$ \Downarrow $$
$$ \{(X+Y)-Y=a \; \land Y=b \} \; X:=X+Y \; \{X-Y=a \; \land \; Y=b\} $$
Semplificando ancora una volta la precondizione si ottiene:
$$ \{X=a \; \land Y=b \} \; X:=X+Y \; \{X-Y=a \; \land \; Y=b\} $$
Che è quanto volevamo dimostrare.
\end{proof}

\subsection{Esercizio 2}
Dare una dimostrazione per la seguente tripla di Hoare:
$$ \{X=R+(Y \times Q) \} \; BEGIN \; R:=R-Y; \; Q:=Q+1 \; END \; \{X=R+(Y \times Q)\} $$

\begin{proof}[Svolgimento]
Come nell'esercizio precedente, procediamo dal fondo.\\
Applichiamo quindi l'assioma dell'assegnamento:
$$ \{S[\nicefrac{Q+1}{Q}] \} \; Q:=Q+1 \; \{X=R+(Y \times Q)\} $$
$$ \Downarrow $$
$$ \{X=R+(Y \times (Q+1)) \} \; Q:=Q+1 \; \{X=R+(Y \times Q)\} $$
Semplificando la precondizione si ottiene:
$$ \{X=R+Y \times Q + Y \} \; Q:=Q+1 \; \{X=R+(Y \times Q)\} $$
Risalendo di un livello e applicando ancora l'assioma dell'assegnamento si trova:
$$ \{S[\nicefrac{R-Y}{R}] \} \; R:=R-Y \; \{X=R+Y \times Q + Y \} $$
$$ \Downarrow $$
$$ \{X= R-Y+Y \times Q+Y \} \; R:=R-Y \; \{X=R+Y \times Q + Y \} $$
Semplificando la precondizione si ottiene:
$$ \{X= R+(Y \times Q) \} \; R:=R-Y \; \{X=R+Y \times Q + Y \} $$
Che è quanto volevamo dimostrare.
\end{proof}

\subsection{Esercizio 3 \emph{(Esonero del 28/11/2014)}}
Lo xor bit a bit, $ \oplus: \mathbb{N} \times \mathbb{N} \rightarrow \mathbb{N} $, gode delle
seguenti proprietà:
\begin{itemize}
	\item $ x \oplus (y \oplus z) = (x \oplus y) \oplus z $ \emph{(associatività)}
	\item $ x \oplus y = y \oplus x $ \emph{(commutatività)}
	\item $ x \oplus 0 = x $ \emph{(elemento neutro)}
	\item $ x \oplus x = 0 $ \emph{(nipotenza/ogni elemento è l'inverso di se stesso)}
\end{itemize}
Si dimostri, usando la logica di Floyd-Hoare, che la composizione sequenziale:
\begin{center}
\texttt{X := X XOR Y; Y := X XOR Y; X := X XOR Y}
\end{center}
realizza lo scambio dei valori tra le variabili \texttt{X} e \texttt{Y} se queste, all'inizio della computazione, contengono valori naturali.

\begin{proof}[Svolgimento]
Dobbiamo dimostrare che la seguente tripla di Hoare è corretta:

\begin{center}
$ \{ \mactext{X=a} \; \land \; \mactext{Y=b} \} $
\texttt{X := X XOR Y; Y := X XOR Y; X := X XOR Y}
$\{\mactext{X=b} \; \land \; \mactext{Y=a} \} $
\end{center}
Procediamo, al solito, partendo dal fondo. Applichiamo dunque l'assioma dell'assegnamento:

\begin{center}
$ \{ S[\nicefrac{\mactext{X XOR Y}}{\mactext{X}}] \} $
\texttt{X := X XOR Y}
$\{\mactext{X=b} \; \land \; \mactext{Y=a} \} $
\end{center}
$$ \Downarrow $$
\begin{center}
$ \{\mactext{X XOR Y = b} \; \land \mactext{Y=a}  \} $
\texttt{X := X XOR Y}
$\{\mactext{X=b} \; \land \; \mactext{Y=a} \} $
\end{center}

Passiamo al successivo assegnamento:
\begin{center}
$ \{ S[\nicefrac{\mactext{X XOR Y}}{\mactext{Y}} ] \} $
\texttt{Y := X XOR Y}
$ \{\mactext{X XOR Y = b} \; \land \mactext{Y=a} \} $
\end{center}
$$ \Downarrow $$
\begin{center}
$ \{ \mactext{X XOR (X XOR Y) = b} \; \land \; \mactext{X XOR Y = a} \} $
\texttt{Y := X XOR Y}
$ \{ \mactext{X XOR Y = b} \; \land \; \mactext{Y=a} \} $
\end{center}
Applichiamo la proprietà di associatività dello XOR in precondizione:
\begin{center}
$ \{ \mactext{(X XOR X) XOR Y = b} \; \land \; \mactext{X XOR Y = a} \} $
\texttt{Y := X XOR Y}
$ \{ \mactext{X XOR Y = b} \; \land \; \mactext{Y=a} \} $
\end{center}
Applichiamo la proprietà di nipotenza dello XOR in precondizione:
\begin{center}
$ \{ \mactext{0 XOR Y = b} \; \land \; \mactext{X XOR Y = a} \} $
\texttt{Y := X XOR Y}
$ \{ \mactext{X XOR Y = b} \; \land \; \mactext{Y=a} \} $
\end{center}
Applichiamo la proprietà di elemento neutro dello XOR in precondizione:
\begin{center}
$ \{ \mactext{Y=b} \; \land \; \mactext{X XOR Y = a} \} $
\texttt{Y := X XOR Y}
$ \{ \mactext{X XOR Y = b} \; \land \; \mactext{Y=a} \} $
\end{center}

Passiamo ora al successivo, e ultimo, assegnamento della tripla:
\begin{center}
$ \{ S[\nicefrac{\mactext{X XOR Y}}{\mactext{X}} ] \} $
\texttt{X := X XOR Y}
$ \{ \mactext{Y=b} \; \land \; \mactext{X XOR Y = a} \} $
\end{center}
$$ \Downarrow $$
\begin{center}
$ \{ \mactext{Y=b} \; \land \; \mactext{(X XOR Y) XOR Y = a} \} $
\texttt{X := X XOR Y}
$ \{ \mactext{Y=b} \; \land \; \mactext{X XOR Y = a} \} $
\end{center}
Applichiamo la proprietà di associatività dello XOR in precondizione:
\begin{center}
$ \{ \mactext{Y=b} \; \land \; \mactext{X XOR (Y XOR Y) = a} \} $
\texttt{X := X XOR Y}
$ \{ \mactext{Y=b} \; \land \; \mactext{X XOR Y = a} \} $
\end{center}
Applichiamo la proprietà di nipotenza dello XOR in precondizione:
\begin{center}
$ \{ \mactext{Y=b} \; \land \; \mactext{X XOR 0 = a} \} $
\texttt{X := X XOR Y}
$ \{ \mactext{Y=b} \; \land \; \mactext{X XOR Y = a} \} $
\end{center}
Applichiamo la proprietà di elemento neutro dello XOR in precondizione:
\begin{center}
$ \{ \mactext{Y=b} \; \land \; \mactext{X=a} \} $
\texttt{X := X XOR Y}
$ \{ \mactext{Y=b} \; \land \; \mactext{X XOR Y = a} \} $
\end{center}
Otteniamo dunque quello che volevamo dimostrare.
\end{proof}


\subsection{Esercizio 4}

Dimostrare la correttezza della seguente tripla di Hoare:
\begin{lstlisting}[mathescape, numberfirstline=false, frame=single]
$ [x = n] $
if x < 0 then
	y := 0;
else
	y := 1;
	while x > 0 do $ \{y = 2^{n-x} \land x \geq 0 \} $
		y = y*2;
		x = x-1;
$ [y = \lfloor 2^n \rfloor ] $
\end{lstlisting}

\begin{proof}[Svolgimento]
Il codice è completamente annotato. Dimostriamo in primo luogo la correttezza parziale della tripla. Applicando l'assioma dell'if allora otteniamo le due triple:
\begin{align}
& \{x=n \; \land \; x<0 \} \; \mactext{y:=0} \; \{y= \lfloor 2^n \rfloor \} \\
& \{x=n \; \land \; x \geq 0 \} \; \mactext{y:=1; while} \texttt{\dots } \; \{ y= \lfloor 2^n \rfloor \}
\end{align}
Dalla (1) ricaviamo la prima VC:
$$ x = n \; \land \; x<0 \; \Rightarrow \; 0 = \lfloor 2^n \rfloor $$
Ed è banale argomentarne la veridicità.\
Dalla (2), dal momento che la postcondizione dopo l'assegnamento \texttt{y:=1} è l'invariante del While, applicando l'assioma derivato dell'assegnamento si ottiene la seconda VC:
$$ x=n \; \land \; x \geq 0 \; \Rightarrow \; 1 = 2^{n-x} \; \land \; x \geq 0 $$
Ed anche in questo caso è banale argomentare la veridicità di questa implicazione.\
Ci rimane da dimostrare la tripla di Hoare:
$$ \{ y=2^{n-x} \; \land \; x>0 \} \; \mactext{while} \texttt{\dots } \; \{y= \lfloor 2^n \rfloor \} $$
Applicando la regola derivata del While si ottengono le seguenti VCs:
\begin{itemize}
	\item $ y=2^{n-x} \; \land \; x \geq 0 \; \Rightarrow \; y=2^{n-x} \; \land \; x \geq 0 $ \\
		  che è banalmente vera.
	\item $ y=2^{n-x} \; \land \; x \geq 0 \; \land \; x \leq 0 \; \Rightarrow \; y = \lfloor 2^n \rfloor $ \\
		  ed è vera in quanto $ x \geq 0 \; \land \; x \leq 0 \; \Rightarrow \; x = 0 $ e quindi
		  dall'antecedente si ottiene il conseguente.
	\item Tutte le VCs generate dalla tripla:
		  $$ \{y=2^{n-x} \; \land \; x \geq 0 \; \land \; x>0 \} \;
		     \mactext{y:=y*2; x=x-1}
		     \; \{y=2^{n-x} \; \land \; x \geq 0 \} $$
		  Applicando la regola dell'assegnamento in sequenza e la regola derivata dell'assegnamento ricaviamo
		  l'ultima VC:
		  $$ y=2^{n-x} \; \land \;  x \geq 0 \; \land \; x>0 \;
		  	 \Rightarrow
		  	 \; y*2 = 2^{n-x+1} \; \land x-1 \geq 0 $$
		  che si può semplificare in:
		  $$ y=2^{n-x} \; \land \; x>0 \;
		  	 \Rightarrow
		  	 \; y = 2^{n-x} \; \land x-1 \geq 0 $$
		  che ancora una volta è vera.
\end{itemize}
Quindi la correttezza parziale della tripla è dimostrata. Ci rimane da dimostrare la totalità e per farlo dobbiamo provare che valgono le seguenti:
\begin{align*}
& P \; \land \; S \; \Rightarrow \; V \geq 0 \\
& \{P \; \land \; S \; \land \; V=k \} \; C \; \{ P \; \land \; V <k \}
\end{align*}
Si ha:
\begin{itemize}
\item $ y=2^{n-x} \; \land \; x \geq 0 \; \land \; x>0 \; \Rightarrow \; x \geq 0 $ \\
	  che è vera, dato che $ x>0 \; \Rightarrow \; x \geq 0 $.
\item Dobbiamo dimostrare la veridicità della tripla:
		$$ \{y=2^{n-x} \; \land \; x \geq 0 \; \land \; x>0 \; \land x=k \} \;
		\mactext{y:=y*2; x=x-1}
		\; \{y=2^{n-x} \; \land \; x < k \} $$
	  Applicando ancora la regola dell'assegnamento in sequenza e l'assioma derivato dell'assegnamento si ha:
	  $$ y = 2^{n-x} \; \land \; x \geq 0 \; \land \; x=k \;
	     \Rightarrow
	     \; y*2 = 2^{n-x+1} \; \land \; x-1<k $$
	  che si può semplificare in:
	  $$ y = 2^{n-x} \; \land \; x \geq 0 \; \land \; x=k \;
	     \Rightarrow
	     \; y = 2^{n-x} \; \land \; x-1<k $$
	  che è vera, dal momento che si otterrebbe $ k-1<k $.
\end{itemize}

Questo prova la correttezza totale.
\end{proof}

\subsection{Esercizio 5}
Estendere la regola del blocco vista a lezione, svincolandola dalla condizione secondo la quale nessuna variabile che compare all'interno del blocco possa comparire in precondizione o in postcondizione.

\begin{proof}[Svolgimento]
Possiamo, a livello di preprocessore, rinominare tutte le variabili di blocco con un nome univoco $ y_1,\dots ,y_n $, facendo attenzione al fatto che abbiano un identificatore univoco. La regola allora è riscrivibile come:
$$
\prooftree
	\vdash \; \{ P \} \; C[\nicefrac{y_1}{v_1}]\dots [\nicefrac{y_n}{v_n}] \; \{ Q \}
	\justifies
		\{ P \} \; \mactext{BEGIN Var } v_1; \dots v_n; \; C \; \mactext{END} \; \{ Q \}
	\thickness=0.08em
	\using
		(Vars(P) \cup Vars(Q)) \cap \{ y_1,\dots ,y_n \} = \emptyset
\endprooftree
$$
\end{proof}
