\chapter{Semantica assiomatica}

In questo capitolo introdurremo la semantica assiomatica, un particolare
tipo di semantica che permette di dimostrare proprietà di programmi.

\section{Correttezza parziale}\marginpar{Mancino}
\begin{definizione}\summary{(Correttezza parziale)}
Un \emph{giudizio di correttezza parziale} è una tripla
della forma
\[
  \{P\} C \{Q\},
\]
dove $P$ e $Q$ sono espressioni logiche dette,
rispettivamente, \emph{precondizione} e \emph{postcondizione},
e $C$ è un comando. Il significato di questa scrittura è
il seguente: se viene eseguito il comando $C$ in uno stato che
soddisfa $P$ e $C$ termina, allora lo stato risultante dall'esecuzione di $C$
soddisferà $Q$.
\end{definizione}

Esempi di giudizi di correttezza parziale sono i seguenti:
\begin{itemize}
\item
$\{ x = 3 \} x := 4 \{ x = 4 \}$, vera in ogni plausibile linguaggio imperativo;
\item
$\{ x = 3 \} x := 4 \{ y = 3 \}$, vera in WHILE ma, in generale,
falsa in altri linguaggi (si consideri il caso, in C++, in cui $y$ sia
un riferimento a $x$);
\item
$\{ P \} \kw{skip} \{ P \}$, vera in WHILE, il che caratterizza
$\kw{skip}$ come un comando che preserva la verità di ogni asserzione.
\end{itemize}

Come si può notare dai precedenti esempi, ciò che asserisce un
giudizio di correttezza parziale può essere vero o falso
in dipendenza dalla semantica del linguaggio di programmazione
considerato.
Definire la verità/falsità di tali giudizi è quindi il modo
per definire tale semantica che va sotto il nome di
\emph{semantica assiomatica}.

\section{Correttezza totale}\marginpar{Lombardi}
\begin{definizione}\summary{(Correttezza totale)}
Un \emph{giudizio di correttezza totale} è una tripla della forma
\[
  [P] C [Q].
\]
A differenza della correttezza parziale la verità di tale giudizio
implica che $C$, se eseguito in uno stato che soddisfa $P$,
termina sempre e risulta in uno store che soddisfa $Q$.
\end{definizione}

I giudizi di correttezza parziale e quelli di correttezza totale
sono anche detti \emph{triple di Hoare}, dal nome del matematico,
C.A.R.\ Hoare che le ha introdotte.

Nel seguito ci occuperemo principalmente di correttezza parziale.
Come detto, ciò che manca per arrivare alla correttezza totale
è una prova di terminazione.  I due aspetti sono relativamente
ortogonali e possono essere affrontati separatamente l'uno
dall'altro.  Informalmente si può scrivere l'equazione:
\[
  \textrm{correttezza totale}
    = \textrm{correttezza parziale} + \textrm{terminazione}.
\]

\section{Logica di specifica}\marginpar{Lombardi}
\input{logica}

\subsection{Programma propriamente annotato}\marginpar{Mancino}
\begin{definizione}
Un programma si dice \emph{propriamente annotato} se ci sono annotazioni nei seguenti punti:
\begin{itemize}
        \item Prima ogni comando $C_i$ in una composizione sequenziale $C_1;C_2; \dots ;C_n$ in cui $C_i$ non è un comando di assegnamento.
        \item Dopo la parola \textbf{do} in un comando \textbf{while}.
\end{itemize}
\end{definizione}


\section{Esercizi}\marginpar{Mancino}

\subsection{Esercizio 1}
Dare una dimostrazione per la seguente tripla di Hoare:
\[ \{X=a  \land Y=b\}  X:=X+Y; \; Y:=X-Y; \; X:=X-Y  \{Y=a  \land  X=b\} \]

\begin{proof}
Dimostriamo la tripla partendo dal fondo. Applicando l'assioma dell'assegnamento si ha:
\begin{align*}
  \bigl\{S[\nicefrac{X-Y}{X}] \bigr\} &  X:=X-Y  \bigl\{Y=a  \land  X=b\bigr\}\\
  \bigl\{Y=a  \land X-Y=b \bigr\} & X:=X-Y  \bigl\{Y=a  \land  X=b\bigr\}
\end{align*} 
Risaliamo ora di un livello applicando ancora l'assioma dell'assegnamento:
\begin{align*}
  \bigl\{S[\nicefrac{X-Y}{Y}] \bigr\} & Y:=X-Y \bigl\{Y=a  \land  X-Y=b\bigr\}\\
  \bigl\{X-Y=a  \land X-(X-Y)=b \bigr\} & Y:=X-Y \bigl\{Y=a  \land  X-Y=b\bigr\}
\end{align*}
Semplificando la precondizione si ottiene:
\[ \bigl\{X-Y=a  \land Y=b \bigr\}  Y:=X-Y  \bigl\{Y=a  \land  X-Y=b\bigr\} \]
Risaliamo ulteriormente di un livello, applicando l'assioma dell'assegnamento. Si ha:
\begin{align*}
  \bigl\{S[\nicefrac{X+Y}{Y}] \bigr\} & X:=X+Y \bigl\{X-Y=a  \land  Y=b\bigr\}\\
  \bigl\{(X+Y)-Y=a  \land Y=b \bigr\} & X:=X+Y \bigl\{X-Y=a  \land  Y=b\bigr\}
\end{align*}
Semplificando ancora una volta la precondizione si ottiene:
\[ \bigl\{X=a  \land Y=b \bigr\}  X:=X+Y  \bigl\{X-Y=a  \land  Y=b\bigr\} \]
Che è quanto volevamo dimostrare.
\end{proof}

\subsection{Esercizio 2}
Dare una dimostrazione per la seguente tripla di Hoare:
\[ 
  \{X=R+(Y \times Q) \} \mactext{BEGIN } R:=R-Y; Q:=Q+1
  \mactext{ END} \{X=R+(Y \times Q)\} 
\]

\begin{proof}
Come nell'esercizio precedente, procediamo dal fondo.\\
Applichiamo quindi l'assioma dell'assegnamento:
\begin{align*}
  \bigl\{S[\nicefrac{Q+1}{Q}] \bigr\} & Q:=Q+1 \bigl\{X=R+(Y \times Q)\bigr\}\\
  \bigl\{X=R+(Y \times (Q+1)) \bigr\} & Q:=Q+1 \bigl\{X=R+(Y \times Q)\bigr\}
\end{align*}
Semplificando la precondizione si ottiene:
\[ \bigl\{X=R+Y \times Q + Y \bigr\} Q:=Q+1 \bigl\{X=R+(Y \times Q)\bigr\} \]
Risalendo di un livello e applicando ancora l'assioma dell'assegnamento si trova:
\begin{align*}
\bigl\{S[\nicefrac{R-Y}{R}] \bigr\} & R:=R-Y \bigl\{X=R+Y \times Q + Y \bigr\}\\
\bigl\{X= R-Y+Y \times Q+Y \bigr\} & R:=R-Y \bigl\{X=R+Y \times Q + Y \bigr\}
\end{align*}
Semplificando la precondizione si ottiene:
\[ \bigl\{X= R+(Y \times Q) \bigr\} R:=R-Y \bigl\{X=R+Y \times Q + Y \bigr\} \]
Che è quanto volevamo dimostrare.
\end{proof}

\subsection{Esercizio 3 \emph{(Esonero del 28/11/2014)}}
Lo xor bit a bit, $ \oplus: \ \times \Nset \rightarrow \Nset $, gode delle
seguenti proprietà:
\begin{itemize}
        \item $ x \oplus (y \oplus z) = (x \oplus y) \oplus z $ \law{associatività}
        \item $ x \oplus y = y \oplus x $ \law{commutatività}
        \item $ x \oplus 0 = x $ \law{elemento neutro}
        \item $ x \oplus x = 0 $ \law{nipotenza/ogni elemento è l'inverso di se stesso}
\end{itemize}
Si dimostri, usando la logica di Floyd-Hoare, che la composizione sequenziale:
\begin{center}
\texttt{X := X XOR Y; Y := X XOR Y; X := X XOR Y}
\end{center}
realizza lo scambio dei valori tra le variabili \texttt{X} e \texttt{Y} se queste, all'inizio della computazione, contengono valori naturali.

\begin{proof}
Dobbiamo dimostrare che la seguente tripla di Hoare è corretta:
\[
  \bigl\{ \mactext{X=a } \land \mactext{ Y=b} \bigr\} 
  \mactext{X := X XOR Y; Y := X XOR Y; X := X XOR Y}
  \bigl\{\mactext{X=b } \land \mactext{ Y=a} \bigr\}
\]
Procediamo, al solito, partendo dal fondo. Applichiamo dunque l'assioma dell'assegnamento:
\begin{align*}
  \bigl\{ S[\nicefrac{\mactext{X XOR Y}}{\mactext{X}}] \bigr\} &
  \mactext{X := X XOR Y}
  \bigl\{\mactext{X=b} \; \land \; \mactext{Y=a} \bigr\} 
  \\
  \bigl\{\mactext{X XOR Y = b } \land \mactext{ Y=a}  \bigr\} &
  \mactext{X := X XOR Y}
  \bigl\{\mactext{X=b } \land \mactext{ Y=a} \bigr\}
\end{align*}
Passiamo al successivo assegnamento:
\begin{align*}
  \bigl\{ S[\nicefrac{\mactext{X XOR Y}}{\mactext{Y}} ] \bigr\} &
  \mactext{Y := X XOR Y}
  \bigl\{\mactext{X XOR Y = b } \land \mactext{ Y=a} \bigr\}
  \\
  \bigl\{ \mactext{X XOR (X XOR Y) = b } \land \mactext{ X XOR Y = a} \bigr\} &
  \mactext{Y := X XOR Y}
  \bigl\{ \mactext{X XOR Y = b } \land \mactext{ Y=a} \bigr\}
\end{align*}
Applichiamo la proprietà di associatività dello XOR in precondizione:
\[
  \bigl\{ \mactext{(X XOR X) XOR Y = b } \land \mactext{ X XOR Y = a} \bigr\}
  \texttt{Y := X XOR Y}
  \bigl\{ \mactext{X XOR Y = b } \land \mactext{ Y=a} \bigr\}
\]
Applichiamo la proprietà di nipotenza dello XOR in precondizione:
\[
  \bigl\{ \mactext{0 XOR Y = b } \land \mactext{ X XOR Y = a} \bigr\}
  \mactext{Y := X XOR Y}
  \bigl\{ \mactext{X XOR Y = b } \land \mactext{ Y=a} \bigr\}
\]
Applichiamo la proprietà di elemento neutro dello XOR in precondizione:
\[
  \bigl\{ \mactext{Y=b } \land \mactext{ X XOR Y = a} \bigr\}
  \mactext{Y := X XOR Y}
  \bigl\{ \mactext{X XOR Y = b } \land \mactext{ Y=a} \bigr\}
\]
Passiamo ora al successivo, e ultimo, assegnamento della tripla:
\begin{align*}
  \bigl\{ S[\nicefrac{\mactext{X XOR Y}}{\mactext{X}} ] \bigr\} &
  \mactext{X := X XOR Y}
  \bigl\{ \mactext{Y=b } \land \mactext{ X XOR Y = a} \bigr\}
  \\
 \bigl\{ \mactext{Y=b } \land \mactext{ (X XOR Y) XOR Y = a} \bigr\} &
  \mactext{X := X XOR Y}
  \bigl\{ \mactext{Y=b } \land \mactext{ X XOR Y = a} \bigr\}
\end{align*}
Applichiamo la proprietà di associatività dello XOR in precondizione:
\[
  \bigl\{ \mactext{Y=b } \land \mactext{ X XOR (Y XOR Y) = a} \bigr\}
  \mactext{X := X XOR Y}
  \bigl\{ \mactext{Y=b } \land \mactext{ X XOR Y = a} \bigr\}
\]
Applichiamo la proprietà di nipotenza dello XOR in precondizione:
\[
  \bigl\{ \mactext{Y=b } \land \mactext{ X XOR 0 = a} \bigr\}
  \texttt{X := X XOR Y}
  \bigl\{ \mactext{Y=b } \land \mactext{ X XOR Y = a} \bigr\}
\]
Applichiamo la proprietà di elemento neutro dello XOR in precondizione:
\[
  \bigl\{ \mactext{Y=b } \land \mactext{ X=a} \bigr\}
  \texttt{X := X XOR Y}
  \bigl\{ \mactext{Y=b } \land \mactext{ X XOR Y = a} \bigr\}
\]
Otteniamo dunque quello che volevamo dimostrare.
\end{proof}


\subsection{Esercizio 4}
Dimostrare la correttezza della seguente tripla di Hoare:
\begin{lstlisting}[mathescape, numberfirstline=false, frame=single]
$ [x = n] $
if x < 0 then
        y := 0;
else
        y := 1;
        while x > 0 do $ \{y = 2^{n-x} \land x \geq 0 \} $
                y = y*2;
                x = x-1;
$ [y = \lfloor 2^n \rfloor ] $
\end{lstlisting}

\begin{proof}
Il codice è completamente annotato. Dimostriamo in primo luogo la correttezza parziale della tripla. Applicando l'assioma dell'if allora otteniamo le due triple:
\begin{align}
& \{x=n \land x<0 \} \mactext{ y:=0 } \{y= \lfloor 2^n \rfloor \} \\
& \{x=n \land x \geq 0 \} \mactext{ y:=1; while} \texttt{\dots } \{ y= \lfloor 2^n \rfloor \}
\end{align}
Dalla (1) ricaviamo la prima VC:
\[ x = n \land x<0 \Rightarrow 0 = \lfloor 2^n \rfloor \]
Ed è banale argomentarne la veridicità.\
Dalla (2), dal momento che la postcondizione dopo l'assegnamento \texttt{y:=1} è l'invariante del While, applicando l'assioma derivato dell'assegnamento si ottiene la seconda VC:
\[ x=n \land x \geq 0 \Rightarrow 1 = 2^{n-x} \land x \geq 0 \]
Ed anche in questo caso è banale argomentare la veridicità di questa implicazione.\
Ci rimane da dimostrare la tripla di Hoare:
\[ \{ y=2^{n-x} \land x>0 \} \mactext{ while} \texttt{\dots } \{y= \lfloor 2^n \rfloor \} \]
Applicando la regola derivata del While si ottengono le seguenti VCs:
\begin{itemize}
  \item $ y=2^{n-x} \land x \geq 0 
        \Rightarrow y=2^{n-x} \land x \geq 0 $,
        che è banalmente vera.
  \item $ y=2^{n-x} \land x \geq 0 \land x \leq 0
        \Rightarrow y = \lfloor 2^n \rfloor $,
        ed è vera in quanto
        $ x \geq 0 \land x \leq 0\Rightarrow x = 0 $
        e quindi dall'antecedente si ottiene il conseguente.
  \item Tutte le VCs generate dalla tripla:
        \[ \{y=2^{n-x} \land x \geq 0 \land x>0 \}
        \mactext{y:=y*2; x=x-1}
        \{y=2^{n-x} \land x \geq 0 \} \]
        Applicando la regola dell'assegnamento in sequenza
        e la regola derivata dell'assegnamento ricaviamo
        l'ultima VC:
        \[ y=2^{n-x} \land x \geq 0 \land x>0
        \Rightarrow
        y*2 = 2^{n-x+1} \land x-1 \geq 0 \]
        che si può semplificare in:
        \[ y=2^{n-x} \land x>0
        \Rightarrow
        y = 2^{n-x} \land x-1 \geq 0 \]
        che ancora una volta è vera.
\end{itemize}
Quindi la correttezza parziale della tripla è dimostrata. Ci rimane da dimostrare la totalità e per farlo dobbiamo provare che valgono le seguenti:
\begin{align*}
& P \land S \Rightarrow V \geq 0 \\
& \{P \land S \land V=k \} C \{ P \land V <k \}
\end{align*}
Si ha:
\begin{itemize}
\item $ y=2^{n-x} \land x \geq 0 \land x>0 \Rightarrow x \geq 0 $ \\
          che è vera, dato che $ x>0 \Rightarrow x \geq 0 $.
\item Dobbiamo dimostrare la veridicità della tripla:
      \[ \{y=2^{n-x} \land x \geq 0 \land x>0 \land x=k \}
      \mactext{y:=y*2; x=x-1}
      \{y=2^{n-x} \land x < k \} \]
      Applicando ancora la regola dell'assegnamento in sequenza
      e l'assioma derivato dell'assegnamento si ha:
      \[ y = 2^{n-x} \land x \geq 0 \land x=k
      \Rightarrow
      y*2 = 2^{n-x+1} \land x-1<k \]
      che si può semplificare in:
      \[ y = 2^{n-x} \land x \geq 0 \land x=k
      \Rightarrow
      y = 2^{n-x} \land x-1<k \]
      che è vera, dal momento che si otterrebbe $ k-1<k $.
\end{itemize}

Questo prova la correttezza totale.
\end{proof}

\subsection{Esercizio 5}
Estendere la regola del blocco vista a lezione, svincolandola dalla condizione secondo la quale nessuna variabile che compare all'interno del blocco possa comparire in precondizione o in postcondizione.

\begin{proof}
Possiamo, a livello di preprocessore, rinominare tutte le variabili di blocco con un nome univoco $ y_1,\dots ,y_n $, facendo attenzione al fatto che abbiano un identificatore univoco. La regola allora è riscrivibile come:
\[
\prooftree
        \vdash \; \{ P \} \; C[\nicefrac{y_1}{v_1}]\dots [\nicefrac{y_n}{v_n}] \; \{ Q \}
        \justifies
                \{ P \} \; \mactext{BEGIN Var } v_1; \dots v_n; \; C \; \mactext{END} \; \{ Q \}
        \thickness=0.08em
        \using
                (Vars(P) \union Vars(Q)) \inters \{ y_1,\dots ,y_n \} = \emptyset
\endprooftree
\]
\end{proof}
